#!/bin/sh
set -e

# Ruta de datos dentro del contenedor
DATADIR="/var/lib/mysql"

# Asegurar directorios y permisos
mkdir -p /var/run/mysqld "$DATADIR"
chown -R mysql:mysql /var/run/mysqld "$DATADIR"

# Si el directorio está vacío, inicializamos la base de datos
if [ -z "$(ls -A "$DATADIR")" ]; then
  echo "[entrypoint] Inicializando datos de MariaDB en $DATADIR"
  mysqld --initialize-insecure --datadir="$DATADIR"
fi

# Si existen secretos, los usamos para configurar contraseña root
# Espera que docker secrets monten en /run/secrets/*
if [ -f /run/secrets/mariadb_root_password ]; then
  ROOT_PASS="$(cat /run/secrets/mariadb_root_password)"
else
  ROOT_PASS="${MYSQL_ROOT_PASSWORD:-}"
fi

if [ -f /run/secrets/wp_db_password ]; then
  WORDPRESS_DB_PASSWORD="$(cat /run/secrets/wp_db_password)"
fi

# Si root tiene contraseña, aplicarla en primera ejecución
# Lanzamos mariadb en background para ejecutar acciones de inicialización seguras
if [ -n "$ROOT_PASS" ]; then
  echo "[entrypoint] Starting temporary mysqld to set root password and create DB/user if needed"
  mysqld --skip-networking --datadir="$DATADIR" &
  pid="$!"

  # esperar a que mariadb esté listo
  i=0
  while ! mysqladmin ping --silent >/dev/null 2>&1; do
    i=$((i+1))
    if [ $i -gt 30 ]; then
      echo "[entrypoint] mariadb did not start in time" >&2
      tail -n 200 "$DATADIR"/*.err 2>/dev/null || true
      exit 1
    fi
    sleep 1
  done

  # aplicar password root y crear DB/usuario si se piden variables de entorno
  if [ -n "$WORDPRESS_DB_NAME" ] && [ -n "$WORDPRESS_DB_USER" ] && [ -n "$WORDPRESS_DB_PASSWORD" ]; then
    mysql -e "CREATE DATABASE IF NOT EXISTS \`$WORDPRESS_DB_NAME\`;"
    mysql -e "CREATE USER IF NOT EXISTS '$WORDPRESS_DB_USER'@'%' IDENTIFIED BY '$WORDPRESS_DB_PASSWORD';"
    mysql -e "GRANT ALL PRIVILEGES ON \`$WORDPRESS_DB_NAME\`.* TO '$WORDPRESS_DB_USER'@'%';"
    mysql -e "FLUSH PRIVILEGES;"
  fi

  # cambiar root password
  mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED BY '${ROOT_PASS}'; FLUSH PRIVILEGES;"

  # detener proceso temporal
  mysqladmin shutdown || kill "$pid" || true
fi

# Finalmente arrancar MariaDB en primer plano
exec mysqld --datadir="$DATADIR"
